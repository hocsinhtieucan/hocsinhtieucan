// Initial content data
let contentData = [
    {
        id: 1,
        title: "TIPS ÔN THI ĐÁNH GIÁ NĂNG LỰC DHQG HỒ CHÍ MINH",
        date: "Ngày 4 - tháng 6 - 2025",
        content: `
            <span class="hashtag">#Tapngai2433</span>
            <p>chị trả lời #tieucan3534 nhe, nếu e muốn ôn thi đgnl thì e cần tìm hiểu cấu trúc của đề thi trước  nhe</p>
            <p>- Thứ nhất đề thi có 3 phần gồm 120 câu :</p>
            <p>+ Phần 1 sử dụng ngôn ngữ gồm có tiếng việt và tiếng anh. Tiếng việt (30 câu) e cần nắm biện pháp tu từ, phép liên kết, câu và thành phần câu, lỗi sai trong câu, tìm từ đúng chính tả, đúng ngữ pháp, ca dao, tục ngữ, thành ngữ, từ hán việt..v.v... đặc biệt là phải đọc hiểu được văn bản nhe. Tiếng anh( 30 câu) chị nghĩ e nên học từ vựng nhiều vào còn cấu trúc thì nó sẽ có phát hiện lỗi sai, câu đồng nghĩa, đọc hiểu..v.v...</p>
            <p>+ Phần 2 toán học ( 30 câu) đề rộng mênh mông mình không đoán được sẽ cho cái gì nên e cứ tập trung vào toán 10 11 12 trước nhe, hiện tại e có thể xps môn toán trước nếu lẹ thì e cố gắng hoàn thành toán 12 và tổng ôn kiến thức 10 11 vào cuối tháng 12 nhe để qua tháng 1 mình tập trung giải đề minh họa đgnl</p>
            <p>+ Phần 3 tư duy khoa học có 2 mục nhỏ, 1 là logic phân tích số liệu ( 12 câu) phần này khó nhe vì mình cũng ít tiếp xúc và đòi hỏi tư duy cao lắm nên mình cần phải tìm đề, luyện dạng này nhiều vào luyện nhiều để luyện khả năng suy luận, nhạy bén hơn với dạng đề này nha hong là vô phòng thi ngáo thiệt á nhe mấy bro. 2 là suy luận khoa học ( 18 câu) phần này có thể nói là dễ vì nó có dữ liệu cho mình đọc hiểu và làm, cũng có thể nói phần này dựa vào khả năng hiểu biết của e nữa nha vì 6 môn mỗi môn 3 câu mà mình học chương trình mới sẽ có môn mình không học nên gần như những câu không biết mình sẽ lụi hoặc làm theo kiến thức mình có hoặc theo dữ liệu đề cho, nên nếu ôn e nhớ tìm hiểu về những chủ đề có liên quan đến môn học nhen</p>
            <p>Thứ hai e có thể mua các khóa luyện thi đgnl hoặc đi học thêm của giáo viên trường mình nhe ( Thầy Tuấn cô Cúc có nhận ôn nhen e ) còn nếu e muốn tiết kiệm thì vẫn có thể tự ôn ở nhà nhe chị rcm e ytb Luyện thi đánh giá năng lực-cpen team trên đây ôn luyện miễn phí dạy siêu dễ hiểu, đầy đủ tất cả các môn. Em có thể tham khảo đề minh họa đánh giá năng lực năm rồi nhe</p>
            <p>Thứ ba nhớ theo dõi page đgnl để xem thông báo và nhớ theo dõi đề minh họa của năm 2026 nhe khi ôn thi cũng bám sát theo đề để không là mông lung hong biết hướng đi đó nhen</p>
            <p>( Em muốn lấy sách 25 đề luyện thi đgnl đại học qg tphcm thì thả phẫn nộ nhe rồi chị gửi cho )</p>
        `
    },
    {
        id: 2,
        title: "TIPS CẢM THỤ + PHÂN TÍCH VĂN HỌC NGOÀI SGK",
        date: "Ngày 4 - tháng 6 - 2025",
        content: `
            <span class="hashtag">#Tapngai2438</span>
            <p>Xin share một số tips mình làm cho 3554 nha thật ra phân tích thơ thì đầu tiên b phải đọc kĩ đề lên xem xem thơ đang nói về gì và từng câu thơ nói gì, sau đó b cứ note ra giấy nháp những câu cần ptich và những dấu cần ptich (đôi khi những dấu "..." Cũng có thể ptich được) sao đó sắp xếp theo trình tự từng khổ từ trên xuống. Ptich đừng dài dòng mà hãy sâu ý và tránh lang mang câu cú rõ ràng và thuyết phục, b muốn điểm lớn thì cứ ptich nhiều vào và muốn có nhiều từ vựng, ngôn từ thì cần phải đọc thêm sách bên ngoài nữa. Nếu thơ đọc vào không hiểu thì cứ đọc nhiều lần ptich theo ý của mình miễn nó đúng thì oki thôi ạ</p>
        `
    },
    {
        id: 3,
        title: "TIPS TỰ HỌC CODE",
        date: "Ngày 5 - tháng 6 - 2025",
        content: `
            <span class="hashtag">#Tapngai2444</span>
            <p>Mn ơi cho em hỏi tại Trà Vinh mình có trung tâm hay ai dạy lập trình, viết code ngôn ngữ C++ ko ạ em cảm ơn.</p>
            <span class="from">Từ: ADMIN:</span>
            <p>- Tapngai2444 Trung tâm thì ad ko biết. Chứ tự học thì ad biết cách nhé.</p> 
            <p>Em học nhanh qua hết lý thuyết trong vòng 3-4 ngày:</p>
            <p>- Tải app code</p>
            <p>- code được nhập xuất ra màn hình (cin, cout)</p>
            <p>- khai báo biến</p>
            <p>- vòng lặp for, while</p>
            <p>- if else</p>
            <p>- mảng</p>
            <p>- struct</p>
            <p>- con trỏ</p>
            <p>Lên mạng coi lý thuyết, tự gõ theo chạy được là được. Trong vòng ba bốn bữa là dẹp luôn, ko cần học mấy cái đó nữa.</p>
            <p>Sau đó chuyên mục chính đó là code theo đề bài yêu cầu, đây là link các đề bài của 1 giảng viên lâu năm của Đại Học Quốc Gia HCM: <a href="https://tuhoclaptrinhsite.wordpress.com/giai-1000-bai/">https://tuhoclaptrinhsite.wordpress.com/giai-1000-bai/</a></p>
            <p>Code 100 bài sẽ giỏi hơn code 99 bài kakakakaka.</p> 
            <p>Muốn nắm bao quát cách làm, những trường hợp đặc biệt trong từng đề thì em sẽ tham khảo chatgpt hoặc trang web stackoverflow (thí dụ code phép chia, thì cần né trường hợp chia cho 0).</p> 
            <p>- Còn em lười, với k có trung tâm ở tỉnh. Thì mấy bạn ad nó hay mua khóa học ở 28tech, em tham khảo trên đó thử. Thấy ở đó dạy ok.</p>
            <p>PS: Trong quá trình học, có chỗ nào khó hiểu cứ gửi cfs nhé, iu iu</p>
            <p>-Nhưng khuyên là nên tự học, vì thằng giỏi nhất ad từng gặp thì là 100% nó tự cày.</p>
        `
    },
    {
        id: 4,
        title: "CÁCH GỬI ĐỒ CHO BẠN Ở XA",
        date: "Ngày 6 - tháng 6 - 2025",
        content: `
            <span class="hashtag">#Tieucan3567</span>
            <p>Dạ mấy bồ ơi chỉ tui cách gửi hàng đi nơi khác với ạ, tui muốn tặng quà cho bạn trên mạng của tui á nếu được thì cmt chi tiết cách gửi được khum ạ..kiểu vô đó phải làm gì làm gì á^^</p>
            
            <span class="from">Từ: Lý Thái Thạnh</span>
            <p>#tieucan3567 bạn tải app Viettel post hoặc shopee post</p>
            <p>-Viettle post có tiện lợi là được hoàn tiền hàng khi lạc hàng với viettle post cx ít lạc hàng</p>
            <p>-Bù lại giá ship khá cao hơn shopee</p>
            <p>Shopee thì ship rẻ hơn nhưng k đc hoàn tiền hàng khi lạc và lạc hàng khá cao nhưng tui nghe nói chứ lúc sài k bị lạc</p>
            <p>-Cách tạo thì bạn tải app rồi điền địa chỉ ,xong lấy 1 tờ giấy ghi mã vận đơn của đơn hàng và địa chỉ người nhận rồi dán lên hộp,bạn có thể in rồi dán hoặc ghi tay ,bạn chọn khung giờ lấy hàng,điền xong thì shipper sẽ lại lấy và giao đi,hành trình đơn hàng trên app,có số điện thoại của tài xế app với bưu cục nên nếu lạc hàng thì có thể liên hệ giải quyết.</p>
            <p>gửi thì có mục người nhận chịu phí hoặc người gửi chịu phí</p>
            <p>Vtp giờ ship tầm 30 k</p>
            <p>Nhầm tài khoản do tạo nhiều đơn với số lượng bình ổn theo tháng thì sẽ được giảm ship,với tài khoản tạo trước ngày vtp đổi phí ship thì gọi là tài khoảng có ship cũ</p>
            <p>Spx giờ chắc tầm 20k</p>
            <p>Ship sẽ tùy số kg á</p>
            
            <span class="from">Từ: Gwen Stacy</span>
            <p>#Tieucan3567 tải app viettle post nha, thao tác trên đt có shipper lại nhà lấy hoặc tự bạn đi gửi cũng đc</p>
            <p>⇒ 0 phải chủ cfs nhma em hỏi ké mất phí bao nhiêu để gửi đi vậy ạ?</p>
            <p>⇒ tuỳ theo số kí với xa hay gần nè, tầm 3 mấy nghìn đổ lại</p>
            
            <span class="from">Từ: Tram Ngoc Nhu Quynh</span>
            <p>#3567 tải app viettel post nha</p>
        `
    },
    {
        id: 5,
        title: "CÁCH HẾT MỤN & THÂM Ở LƯNG, NGỰC",
        date: "Ngày 7 - tháng 6 - 2025",
        content: `
            <span class="hashtag">#Tapngai2451</span>
            <p>Có ai biết cách nào để hết mụn với thâm ở lưng với ngực không ạ</p>
            
            <span class="from">Từ Gwen Stacy</span>
            <p>#Tapngai2451</p>
            <p>tắm gynofar thử nha bạn, ko ăn đồ cay nóng, uống nhiều nước lọc, đi tắm lau khô kỹ, dính mưa phải tắm lại ngay, chốt lại là tắm sạch, nhất là khi ra mồ hôi, tránh mặc đồ quá chật gây bí da, con gái thì chọn bra chất liệu thoáng chút</p>
            <p>vệ sinh ga nệm định kì tại nhiều khi mụn là do ga gối bị bẩn</p>
            <p>có tiền thì nên mua Paula's Choice Body Treatment 2% BHA loại mini size cũng được có 300 à dùng ok lắm, mờ thâm bạn dùng niacinamide 10% the ordinary nha</p>
        `
    },
    {
        id: 6,
        title: "CHỖ BÁN BỘT CHIÊN Ở TIỂU CẦN",
        date: "Ngày 7 - tháng 6 - 2025",
        content: `
            <span class="hashtag">#Tieucan3571</span>
            <p>ở tc có chỗ nào bán bột chiên hok mn, mình chưa từng ăn muốn ăn thử nhưng k tìm được quán nào hết</p>
            
            <span class="from">From: Hoàng Hân</span>
            <p>tc3571 chỗ gần siêu thị có chỗ bán nè b của 2 cô chú dth lắm siêu nhiều trứng luôn</p>
            
            <span class="from">From: Giaa Nghii</span>
            <p>#Tieucan3571 ở chỗ cafe le le á chạy xuống tí có chỗ ngta bán xe rồi bán bún nước lèo á 1h 2h ngta ms bán, có bán lẻ bột chiên á b oi</p>
        `
    },
    {
        id: 7,
        title: "CHỖ BÁN BÁNH MÌ CHẢ CÁ Ở TIỂU CẦN",
        date: "Ngày 7 - tháng 6 - 2025",
        content: `
            <span class="from">FROM Yen Changg:</span>
            <p>#tc3578 theo tuii thấy thì là chỗ vừa xuống dốc cầu TC nhennn</p>
            
            <span class="from">FROM Nguyễn Huy:</span>
            <p>bánh mỳ chả cá nhà bà Hà ngon nhất Tiểu Cần #3578</p>
        `
    },
    {
        id: 8,
        title: "PHÒNG TẬP GYM Ở ĐÂU?",
        date: "Ngày 7 - tháng 6 - 2025",
        content: `
            <span class="from">From: Minh Phụng</span>
            <p>#Tieucan3460 Ở Kan Gym á bạn, thấy cũng ok</p>
        `
    }
];

// Check if there's saved content in localStorage or load from data/posts.json
async function loadInitialContent() {
    // First try to get from localStorage
    if (localStorage.getItem('confessionContent')) {
        contentData = JSON.parse(localStorage.getItem('confessionContent'));
        return;
    }
    
    // If not in localStorage, try to fetch from data/posts.json
    try {
        const response = await fetch('data/posts.json');
        if (response.ok) {
            contentData = await response.json();
            // Save to localStorage for future use
            localStorage.setItem('confessionContent', JSON.stringify(contentData));
        }
    } catch (error) {
        console.log('Không thể tải nội dung từ file posts.json', error);
        // Using default contentData
    }
}

// Admin password - simple for demo purposes
const ADMIN_PASSWORD = "kiamangdemhiuhatmangtenemquayvetrongkyuc";

// DOM Elements
const tocElement = document.getElementById('toc');
const contentElement = document.getElementById('content');
const backToTopBtn = document.getElementById('back-to-top');
const adminBtn = document.getElementById('admin-btn');
const adminModal = document.getElementById('admin-modal');
const contentModal = document.getElementById('content-modal');
const adminDashboard = document.getElementById('admin-dashboard');
const adminPasswordInput = document.getElementById('admin-password');
const loginBtn = document.getElementById('login-btn');
const closeButtons = document.querySelectorAll('.close');
const addContentForm = document.getElementById('add-content-form');
const contentModalTitle = document.getElementById('content-modal-title');
const contentIdInput = document.getElementById('content-id');
const cancelEditBtn = document.getElementById('cancel-edit');
const addNewContentBtn = document.getElementById('add-new-content');
const formatButtons = document.querySelectorAll('.format-btn');
const contentTextarea = document.getElementById('content-text');

// Initialize the page
function initPage() {
    generateTableOfContents();
    renderContent();
    setupEventListeners();
}

// Generate table of contents based on contentData
function generateTableOfContents() {
    tocElement.innerHTML = '';
    
    contentData.forEach(item => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.textContent = item.title;
        a.href = `#section-${item.id}`;
        li.appendChild(a);
        tocElement.appendChild(li);
    });
}

// Render all content sections
function renderContent() {
    contentElement.innerHTML = '';
    
    contentData.forEach(item => {
        const section = document.createElement('div');
        section.className = 'section';
        section.id = `section-${item.id}`;
        
        const title = document.createElement('h2');
        title.textContent = item.title;
        
        const date = document.createElement('span');
        date.className = 'date';
        date.textContent = item.date;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'section-content';
        contentDiv.innerHTML = item.content;
        
        section.appendChild(title);
        section.appendChild(date);
        section.appendChild(contentDiv);
        
        contentElement.appendChild(section);
    });
}

// Setup event listeners
function setupEventListeners() {
    // Back to top button visibility
    window.addEventListener('scroll', () => {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            backToTopBtn.style.display = 'block';
        } else {
            backToTopBtn.style.display = 'none';
        }
    });
    
    // Back to top button click
    backToTopBtn.addEventListener('click', () => {
        document.body.scrollTop = 0; // For Safari
        document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
    });
    
    // Admin button click
    adminBtn.addEventListener('click', () => {
        adminModal.style.display = 'block';
    });
    
    // Close buttons for modals
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            adminModal.style.display = 'none';
            contentModal.style.display = 'none';
            adminDashboard.style.display = 'none';
            resetContentForm();
        });
    });
    
    // Login button click
    loginBtn.addEventListener('click', () => {
        const password = adminPasswordInput.value;
        
        if (password === ADMIN_PASSWORD) {
            adminModal.style.display = 'none';
            adminDashboard.style.display = 'block';
            adminPasswordInput.value = '';
            loadAdminDashboard();
        } else {
            alert('Mật khẩu không đúng!');
        }
    });
    
    // Add new content button click
    addNewContentBtn.addEventListener('click', () => {
        resetContentForm();
        contentModalTitle.textContent = 'Thêm nội dung mới';
        adminDashboard.style.display = 'none';
        contentModal.style.display = 'block';
    });
    
    // Cancel edit button click
    cancelEditBtn.addEventListener('click', () => {
        resetContentForm();
        contentModal.style.display = 'none';
        adminDashboard.style.display = 'block';
    });
    
    // Format buttons click
    formatButtons.forEach(button => {
        button.addEventListener('click', () => {
            const format = button.getAttribute('data-format');
            applyFormatting(format);
        });
    });
    
    // Add content form submit
    addContentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const title = document.getElementById('content-title').value;
        const date = document.getElementById('content-date').value;
        const content = document.getElementById('content-text').value;
        const contentId = document.getElementById('content-id').value;
        
        // Format the content
        const formattedContent = formatContent(content);
        
        if (contentId) {
            // Edit existing content
            const index = contentData.findIndex(item => item.id === parseInt(contentId));
            if (index !== -1) {
                contentData[index].title = title;
                contentData[index].date = date;
                contentData[index].content = formattedContent;
            }
        } else {
            // Add new content
            const newId = contentData.length > 0 ? Math.max(...contentData.map(item => item.id)) + 1 : 1;
            
            const newContent = {
                id: newId,
                title: title,
                date: date,
                content: formattedContent
            };
            
            contentData.push(newContent);
        }
        
        // Save to localStorage
        localStorage.setItem('confessionContent', JSON.stringify(contentData));
        
        // Update the page
        generateTableOfContents();
        renderContent();
        
        // Close the modal and clear the form
        contentModal.style.display = 'none';
        adminDashboard.style.display = 'block';
        resetContentForm();
        loadAdminDashboard();
    });
    
    // Export JSON button
    document.getElementById('export-json').addEventListener('click', exportContentAsJSON);
    
    // Import JSON file
    document.getElementById('import-json').addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            importContentFromJSON(this.files[0]);
            this.value = ''; // Reset file input
        }
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === adminModal) {
            adminModal.style.display = 'none';
        }
        if (e.target === contentModal) {
            contentModal.style.display = 'none';
            resetContentForm();
        }
        if (e.target === adminDashboard) {
            adminDashboard.style.display = 'none';
        }
    });
}

// Format content for proper HTML display
function formatContent(rawContent) {
    // Simple formatting - replace line breaks with paragraphs
    let formatted = '';
    const lines = rawContent.split('\n').filter(line => line.trim() !== '');
    
    lines.forEach(line => {
        // Check if it's a hashtag
        if (line.trim().startsWith('#')) {
            formatted += `<span class="hashtag">${line.trim()}</span>\n`;
        }
        // Check if it's a "From:" line
        else if (line.trim().startsWith('Từ:') || line.trim().startsWith('FROM') || line.trim().startsWith('From:')) {
            formatted += `<span class="from">${line.trim()}</span>\n`;
        }
        // Regular paragraph
        else {
            formatted += `<p>${line.trim()}</p>\n`;
        }
    });
    
    return formatted;
}

// Load admin dashboard with content list
function loadAdminDashboard() {
    const tableBody = document.getElementById('content-table-body');
    tableBody.innerHTML = '';
    
    contentData.forEach(item => {
        const row = document.createElement('tr');
        
        const idCell = document.createElement('td');
        idCell.textContent = item.id;
        
        const titleCell = document.createElement('td');
        titleCell.textContent = item.title;
        
        const dateCell = document.createElement('td');
        dateCell.textContent = item.date;
        
        const actionsCell = document.createElement('td');
        
        // Edit button
        const editBtn = document.createElement('button');
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.classList.add('action-btn', 'edit-btn');
        editBtn.title = 'Sửa';
        editBtn.addEventListener('click', () => editContent(item.id));
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        deleteBtn.classList.add('action-btn', 'delete-btn');
        deleteBtn.title = 'Xóa';
        deleteBtn.addEventListener('click', () => deleteContent(item.id));
        
        const actionDiv = document.createElement('div');
        actionDiv.classList.add('action-buttons');
        actionDiv.appendChild(editBtn);
        actionDiv.appendChild(deleteBtn);
        actionsCell.appendChild(actionDiv);
        
        row.appendChild(idCell);
        row.appendChild(titleCell);
        row.appendChild(dateCell);
        row.appendChild(actionsCell);
        
        tableBody.appendChild(row);
    });
}

// Edit content
function editContent(id) {
    const content = contentData.find(item => item.id === id);
    if (!content) return;
    
    // Set form fields
    contentIdInput.value = content.id;
    document.getElementById('content-title').value = content.title;
    document.getElementById('content-date').value = content.date;
    
    // Convert HTML content back to plain text for editing
    const plainContent = convertHtmlToPlainText(content.content);
    document.getElementById('content-text').value = plainContent;
    
    // Change modal title and show cancel button
    contentModalTitle.textContent = 'Sửa nội dung';
    cancelEditBtn.style.display = 'block';
    
    // Show content modal
    adminDashboard.style.display = 'none';
    contentModal.style.display = 'block';
}

// Delete content
function deleteContent(id) {
    if (confirm('Bạn có chắc chắn muốn xóa nội dung này không?')) {
        contentData = contentData.filter(item => item.id !== id);
        localStorage.setItem('confessionContent', JSON.stringify(contentData));
        
        // Update page
        generateTableOfContents();
        renderContent();
        loadAdminDashboard();
    }
}

// Convert HTML content back to plain text for editing
function convertHtmlToPlainText(html) {
    // Replace hashtag spans
    html = html.replace(/<span class="hashtag">(.*?)<\/span>/g, '$1');
    
    // Replace from spans
    html = html.replace(/<span class="from">(.*?)<\/span>/g, '$1');
    
    // Replace paragraphs
    html = html.replace(/<p>(.*?)<\/p>/g, '$1');
    
    // Replace formatting tags
    html = html.replace(/<strong>(.*?)<\/strong>/g, '**$1**');
    html = html.replace(/<em>(.*?)<\/em>/g, '*$1*');
    html = html.replace(/<u>(.*?)<\/u>/g, '__$1__');
    
    // Split by newlines and trim
    const lines = html.split('\n').map(line => line.trim()).filter(line => line !== '');
    
    return lines.join('\n');
}

// Reset content form
function resetContentForm() {
    addContentForm.reset();
    contentIdInput.value = '';
    contentModalTitle.textContent = 'Thêm nội dung mới';
    cancelEditBtn.style.display = 'none';
}

// GitHub Pages functions
// Export content as JSON file for GitHub Pages
function exportContentAsJSON() {
    const jsonData = JSON.stringify(contentData, null, 2);
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = 'posts.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Đã xuất file JSON thành công! Hãy lưu file này vào thư mục data/ trên GitHub');
}

// Import content from JSON file
function importContentFromJSON(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if (!Array.isArray(importedData)) {
                throw new Error('File JSON không hợp lệ. Dữ liệu phải là một mảng.');
            }
            
            // Validate data structure
            for (const item of importedData) {
                if (!item.id || !item.title || !item.date || !item.content) {
                    throw new Error('File JSON không hợp lệ. Thiếu trường dữ liệu cần thiết.');
                }
            }
            
            // Update content data
            contentData = importedData;
            localStorage.setItem('confessionContent', JSON.stringify(contentData));
            
            // Update UI
            generateTableOfContents();
            renderContent();
            if (document.getElementById('admin-dashboard').style.display === 'block') {
                loadAdminDashboard();
            }
            
            showToast('Đã nhập dữ liệu từ file JSON thành công!');
            
        } catch (error) {
            showToast(`Lỗi khi nhập file JSON: ${error.message}`, true);
        }
    };
    reader.readAsText(file);
}

// Show toast message
function showToast(message, isError = false) {
    // Remove any existing toast
    const existingToast = document.querySelector('.message-toast');
    if (existingToast) {
        document.body.removeChild(existingToast);
    }
    
    // Create new toast
    const toast = document.createElement('div');
    toast.className = `message-toast ${isError ? 'error' : ''}`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Show toast
    setTimeout(() => {
        toast.classList.add('show');
        
        // Hide toast after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    }, 10);
}

// Apply formatting to selected text
function applyFormatting(format) {
    const textarea = document.getElementById('content-text');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    let replacement = '';
    
    switch (format) {
        case 'bold':
            replacement = `**${selectedText}**`;
            break;
        case 'italic':
            replacement = `*${selectedText}*`;
            break;
        case 'underline':
            replacement = `__${selectedText}__`;
            break;
        case 'hashtag':
            replacement = `#${selectedText}`;
            break;
        case 'from':
            replacement = `Từ: ${selectedText}`;
            break;
    }
    
    if (selectedText) {
        textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
        textarea.focus();
        textarea.selectionStart = start;
        textarea.selectionEnd = start + replacement.length;
    } else {
        switch (format) {
            case 'hashtag':
                replacement = `#`;
                break;
            case 'from':
                replacement = `Từ: `;
                break;
            default:
                return; // Don't insert formatting if no selection for bold, italic, underline
        }
        
        textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
        textarea.focus();
        textarea.selectionStart = start + replacement.length;
        textarea.selectionEnd = start + replacement.length;
    }
}

// Format content with bold, italic, and underline
function formatContent(rawContent) {
    // Format bold, italic, underline before paragraph processing
    rawContent = rawContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    rawContent = rawContent.replace(/\*(.*?)\*/g, '<em>$1</em>');
    rawContent = rawContent.replace(/__(.*?)__/g, '<u>$1</u>');
    
    // Simple formatting - replace line breaks with paragraphs
    let formatted = '';
    const lines = rawContent.split('\n').filter(line => line.trim() !== '');
    
    lines.forEach(line => {
        // Check if it's a hashtag
        if (line.trim().startsWith('#')) {
            formatted += `<span class="hashtag">${line.trim()}</span>\n`;
        }
        // Check if it's a "From:" line
        else if (line.trim().startsWith('Từ:') || line.trim().startsWith('FROM') || line.trim().startsWith('From:')) {
            formatted += `<span class="from">${line.trim()}</span>\n`;
        }
        // Regular paragraph
        else {
            formatted += `<p>${line.trim()}</p>\n`;
        }
    });
    
    return formatted;
}

// Initialize the page
async function initPage() {
    await loadInitialContent();
    generateTableOfContents();
    renderContent();
    setupEventListeners();
}

// Initialize the page when DOM is loaded
document.addEventListener('DOMContentLoaded', initPage);